<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplicación Móvil - Inicio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Configuración de Tailwind para usar el color de acento y la fuente Inter */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        html {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        /* Definición de colores base */
        :root {
            --color-bg-light: #f9fafb;
            --color-text-light: #1f2937;
            --color-primary-light: #3b82f6;
            --color-bg-dark: #1f2937;
            --color-text-dark: #f3f4f6;
            --color-primary-dark: #60a5fa;
            --color-surface-light: #ffffff;
            --color-surface-dark: #374151;
            --color-header: #2D59A1; 
            --color-data-text: #ffffff; 
            --color-bg-table-row: #1f2937; 
        }
        
        /* Estilos del cuerpo en modo oscuro */
        .dark { background-color: var(--color-bg-dark); color: var(--color-text-dark); }
        
        #app-container {
            max-width: 500px;
            margin: 0 auto;
            min-height: 10vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
            position: relative; 
            overflow: hidden; 
        }

        header, footer {
            width: 100%;
            max-width: 500px; 
            z-index: 50; 
            transition: background-color 0.3s, color 0.3s;
            left: 50%;
            transform: translateX(-50%);
        }

        /* Estilos específicos para header y footer en modo oscuro */
        .dark header, .dark footer { 
            background-color: var(--color-surface-dark); 
            border-color: #4b5563; 
        }

        main {
            flex-grow: 1;
            overflow: hidden; 
        }
        
        /* CONTENEDOR DESPLEGABLE (SCROLLABLE-CONTENT) */
        #scroll-container {
            height: 100%;
            overflow-y: auto; 
            padding-left: 1rem;
            padding-right: 1rem;
            padding-top: 76px; 
            padding-bottom: 72px; 
            transition: padding 0.3s ease-in-out;
        }

        /* ESTILOS PARA EL CONTENIDO COLAPSABLE */
        #collapsible-content {
            overflow: hidden;
            transition: max-height 0.4s ease-in-out, margin-top 0.4s ease-in-out;
            max-height: 2000px; 
            margin-top: 1.5rem; 
        }
        
        .footer-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px 4px;
            font-size: 0.75rem;
            line-height: 1;
            transition: color 0.2s, background-color 0.2s;
            border-radius: 0.5rem;
            color: inherit;
        }

        .footer-btn.active { color: var(--color-primary-dark); }

        /* ========================================================== */
        /* --- REGLA CSS REUTILIZABLE PARA TARJETAS DE MÉTRICAS --- */
        /* ========================================================== */
        /* Esta clase encapsula el diseño de la tarjeta de métrica individual */
        .metric-card {
            /* w-1/3 py-0 px-1.5 rounded-xl shadow-2xl transition-all duration-300 dark:bg-gray-700 flex items-center space-x-2 */
            width: 33.333333%; /* w-1/3 */
            padding-top: 0; /* py-0 */
            padding-bottom: 0; /* py-0 */
            padding-left: 0.375rem; /* px-1.5 */
            padding-right: 0.375rem; /* px-1.5 */
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); /* shadow-2xl */
            transition: all 300ms; /* transition-all duration-300 */
            display: flex; /* flex */
            align-items: center; /* items-center */
            gap: 0.5rem; /* space-x-2 */
        }
        
        /* ========================================================== */
        /* --- CLASE REUTILIZABLE PARA EL MOTOR DE BÚSQUEDA --- */
        /* ========================================================== */
        /* Encapsula el diseño y espaciado del motor de búsqueda y sus botones */
        .search-actions-container {
            display: flex;
            align-items: center;
            gap: 0.5rem; /* space-x-2 */
            margin-top: 1rem; /* mt-4 */
            width: 100%;
        }
        
        /* Estilo para el input de búsqueda dentro del contenedor */
        .search-input-wrapper {
            position: relative;
            flex-grow: 1;
            border-radius: 0.75rem; /* rounded-xl */
        }
        
        .search-input-wrapper input {
            /* Asegura que el input ocupe el espacio sin romperse */
            width: 100%;
            padding-left: 2.5rem; /* pl-10 */
            padding-right: 1rem; /* pr-4 */
            padding-top: 0.5rem; /* py-2 */
            padding-bottom: 0.5rem; /* py-2 */
            border-radius: 0.75rem;
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06); /* shadow-inner */
            
            /* Colores de fondo y borde para modo oscuro */
            background-color: #374151; /* dark:bg-gray-700 */
            color: #f3f4f6; /* dark:text-gray-100 */
            border: 1px solid #4b5563; /* dark:border-gray-600 */
            
            /* Efecto de foco */
            transition: border-color 0.15s, box-shadow 0.15s;
            outline: none;
        }

        .search-input-wrapper input:focus {
            border-color: #3b82f6; /* focus:ring-blue-500 */
            box-shadow: 0 0 0 2px #3b82f6; /* focus:ring-2 focus:ring-blue-500 */
        }
        
        /* Estilo para el icono de lupa dentro del input */
        .search-icon {
            position: absolute;
            left: 0.75rem; /* left-3 */
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af; /* text-gray-400 */
        }
        
        /* ========================================================== */
        /* --- ESTILOS DE LA TABLA DINÁMICA --- */
        /* ========================================================== */
        
        .table-scroll-container {
            max-height: 360px; 
            overflow-x: auto; 
            overflow-y: auto; 
            border-radius: 0.75rem; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            display: block; 
            border: 1px solid #4b5563; 
            background-color: var(--color-bg-table-row); 
        }
        
        .table-scroll-container table {
            border-collapse: collapse; 
            table-layout: auto; 
            width: max-content; 
            min-width: 100%; 
        }

        .table-scroll-container th {
            position: sticky;
            top: 0; 
            z-index: 20; 
            background-color: var(--color-header); 
            color: var(--color-data-text);
            padding: 0.25rem 0.5rem; 
            text-align: center; 
            white-space: nowrap;
            font-size: 0.75rem; 
            border-bottom: 2px solid rgba(255, 255, 255, 0.1); 
            cursor: pointer;
            text-transform: uppercase;
        }

        .sticky-id-cell {
            position: sticky;
            left: 0;
            z-index: 30; 
            font-weight: bold;
            text-align: center;
            border-right: 1px solid rgba(255, 255, 255, 0.2); 
        }
        
        .table-scroll-container th.sticky-id-cell {
            background-color: var(--color-header); 
            z-index: 40; 
        }
        
        .table-data-cell.sticky-id-cell {
            /* El color de fondo se mantiene aquí para la celda ID pegajosa para distinguirla */
            background-color: var(--color-surface-dark); 
            color: var(--color-primary-dark);
            font-size: 0.75rem; 
        }

        .table-data-cell {
            font-size: 0.875rem; 
            padding-top: 0.25rem; 
            padding-bottom: 0.25rem;
            white-space: nowrap; 
            transition: background-color 0.15s, color: 0.15s, border-color 0.15s;
            border-bottom: 1px solid #4b5563; 
            height: 32px; 
        }
        
        .header-content {
            display: flex;
            align-items: center;
            justify-content: center; 
            gap: 4px;
        }

        .row-warning-text .table-data-cell {
            background-color: #4a3e2a; 
            color: #fcd34d; 
        }
        
        .row-alert-text .table-data-cell {
            background-color: #582b2b; 
            color: #fca5a5; 
            font-weight: 600;
        }
    </style>
</head>
<body class="dark transition-colors duration-300">
    <div id="app-container" class="shadow-xl">
        <header id="app-header" class="fixed top-0 w-full h-14 border-b border-gray-700 dark:border-gray-500 flex items-center justify-between px-4">
            <h1 class="text-xl font-bold cursor-pointer hover:opacity-80 transition-opacity" onclick="window.location.href = 'Inicio.html'">
                Mi Aplicación Móvil ZXC
            </h1>
            <div class="flex space-x-3">
                <button class="p-2 rounded-full hover:opacity-80 transition-opacity" onclick="window.location.href = 'index.html'">
                    <i data-lucide="log-out" class="w-6 h-6 text-red-400 dark:text-red-300"></i>
                </button>
            </div>
        </header>

        <main id="main-content">
            <div id="scroll-container" class="flex flex-col">
                <h2 class="text-2xl font-extrabold text-gray-200 border-b border-gray-700 pb-2">Gestión de Vacaciones</h2>
                
                <div id="table-loading-status" class="mt-8 text-center" style="display:none;">
                </div>

                <!-- INICIO DEL CONTENEDOR METRICAS BD_PERSONAL -->
                <div id="data-view-container" class="w-full mt-4">
                    <!-- Título (sin borde inferior) -->
                    <h2 class="text-xl font-bold pb-2">BD Personal</h2> 
                    
                    <!-- Contenedor de métricas -->
                    <div class="flex justify-between space-x-2 p-1">
                        <!-- Tarjeta de Métrica: Total Empleados - USANDO LA CLASE REUTILIZABLE -->
                        <div id="metric-total-records" class="metric-card"> 
                            <i data-lucide="users" class="w-6 h-6 text-green-500 flex-shrink-0"></i> 
                            <div class="flex flex-col"> 
                                <span class="text-xl font-extrabold text-green-500 leading-none block" data-metric="total">0</span> 
                                <span class="text-xs dark:text-gray-300 whitespace-nowrap leading-none block">Total Empleados</span> 
                            </div> 
                        </div> 
                        <!-- Tarjeta de Métrica: Dados de Baja - USANDO LA CLASE REUTILIZABLE -->
                        <div class="metric-card"> 
                            <i data-lucide="user-minus" class="w-6 h-6 text-red-500 flex-shrink-0"></i> 
                            <div class="flex flex-col"> 
                                <span class="text-xl font-extrabold text-red-500 leading-none block" data-metric="perfil_dados_baja">0</span> 
                                <span class="text-xs dark:text-gray-300 whitespace-nowrap leading-none block">Dados de Baja</span> 
                            </div> 
                        </div> 
                        <!-- Tarjeta de Métrica: Notas/Alertas - USANDO LA CLASE REUTILIZABLE -->
                        <div class="metric-card"> 
                            <i data-lucide="alert-triangle" class="w-6 h-6 text-yellow-500 flex-shrink-0"></i> 
                            <div class="flex flex-col"> 
                                <span class="text-xl font-extrabold text-yellow-500 leading-none block" data-metric="ctrl1_warning">0</span> 
                                <span class="text-xs dark:text-gray-300 whitespace-nowrap leading-none block">Notas/Alertas</span> 
                            </div> 
                        </div> 
                    </div> 
                </div>
                <!-- FIN DEL CONTENEDOR METRICAS BD_PERSONAL -->
                
                <!-- INICIO DEL MOTOR DE BÚSQUEDA Y RECARGA (USANDO LA NUEVA CLASE) -->
                <div id="search-container" class="search-actions-container">
                    <div class="search-input-wrapper">
                        <input type="text" id="search-input" placeholder="Buscar por Nombre, Cédula, Cargo..."
                                class="w-full rounded-xl shadow-inner
                                        text-gray-900 dark:text-gray-100
                                        placeholder-gray-400 focus:ring-2 focus:ring-blue-500"
                                        autocomplete="off">
                        <i data-lucide="search" class="search-icon w-5 h-5 text-gray-500 dark:text-gray-300"></i>
                    </div>
                    <button id="clear-search-btn" class="p-2.5 rounded-full hover:bg-gray-700 shadow-md transition-colors duration-200 text-red-500 dark:text-red-400 font-bold" title="Reiniciar Filtros">
                        <i data-lucide="x-circle" class="w-8 h-8"></i>
                    </button>
                    <button id="reload-icon" class="p-2 rounded-full text-blue-400 hover:bg-gray-700 transition duration-150" title="Recargar Datos (Omitir Caché)">
                        <i data-lucide="refresh-cw" class="w-8 h-8"></i>
                    </button>
                </div>
                <!-- FIN DEL MOTOR DE BÚSQUEDA Y RECARGA -->
                
                <div id="employee-table-wrapper" class="mt-6">
                    <h3 class="text-lg font-semibold mb-3 border-b border-gray-700 pb-2">Base de Datos de Empleados</h3>
                    <div id="employee-table-container" class="table-scroll-container">
                    </div>
                </div>
                
                <button id="toggle-content-btn" class="w-full mt-4 py-2 bg-gray-700 hover:bg-gray-600 text-white font-medium rounded-lg transition-colors duration-200 flex items-center justify-center space-x-2">
                    <i data-lucide="chevrons-up" id="toggle-icon" class="w-5 h-5"></i>
                    <span id="toggle-text">Contraer Detalles</span>
                </button>

                <div id="collapsible-content" class="flex flex-col space-y-6">
                    <button onclick="window.location.href = 'AgregarDat.html'" class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl shadow-lg transition-colors duration-200 flex items-center justify-center space-x-2">
                        <i data-lucide="plus-circle" class="w-5 h-5"></i>
                        <span>Solicitar Nuevas Vacaciones</span>
                    </button>
                </div>
            </div>
        </main>

        <footer id="app-footer" class="fixed bottom-0 w-full h-18 border-t border-gray-700 dark:border-gray-500 flex items-center justify-around py-2">
            <button class="footer-btn active" data-section="Inicio">
                <i data-lucide="home" class="w-6 h-6"></i>
                <span>Inicio</span>
            </button>
            <button class="footer-btn" data-section="Vacaciones">
                <i data-lucide="calendar-days" class="w-6 h-6"></i> 
                <span>Vacaciones</span>
            </button>
            <button class="footer-btn" data-section="Agregar">
                <i data-lucide="calendar-plus" class="w-6 h-6"></i>
                <span>Agregar</span>
            </button>
            <button class="footer-btn" data-section="Perfil">
                <i data-lucide="user" class="w-6 h-6"></i>
                <span>Perfil</span>
            </button>
            <button class="footer-btn" data-section="Configuración">
                <i data-lucide="settings" class="w-6 h-6"></i>
                <span>Config</span>
            </button>
        </footer>
    </div>

    <script>
        // Inicializa los íconos de Lucide
        lucide.createIcons();

        // =================================================================
        // --- CONSTANTES Y VARIABLES GLOBALES (Para la conexión GAS) ---
        // =================================================================
        // API URL for Google Apps Script
        const GET_URL = 'https://script.google.com/macros/s/AKfycbx87WvxA9ca1KyGMA1wsw1npZw5vPtjoItomhF823BICXScNrWGFh5m0Dj6Veb24CtHXQ/exec';
        const TARGET_SHEET_NAME = 'BD_Personal2'; // Sheet name
        const CACHE_KEY = 'employeeDataCache_BD_Personal2';
        const CACHE_EXPIRATION_MS = 15 * 60 * 1000; // 15 minutes
        
        let debounceTimer; // Debounce timer for search
        
        // Mapeo de columnas a mostrar
        const TABLE_COLUMNS = [
            { key: 'EMPRESA', label: 'EMPRESA' },
            { key: 'NOMBRES', label: 'NOMBRES' },
            { key: 'APELLIDOS', label: 'APELLIDOS' },
            { key: 'CEDULA', label: 'CÉDULA' },
            { key: 'NOMINA', label: 'NÓMINA' },
            { key: 'PERFIL', label: 'PERFIL' },
            { key: 'INGRESO', label: 'Ingreso' },
            { key: 'SECTOR', label: 'SECTOR' },
            { key: 'UNIDAD', label: 'UNIDAD' },
            { key: 'CARGO', label: 'CARGO' },
            { key: 'CTRL2', label: 'Días Vacaciones' }, 
        ];

        let allEmployeeData = [];
        let filteredEmployeeData = [];
        let currentSortColumn = null;
        let currentSortDirection = 'asc';
        
        // =================================================================
        // --- FUNCIONES DE MANEJO DE DATOS GAS ---
        // =================================================================
        function buildGasApiUrl(sheetName) {
            return `${GET_URL}?sheet=${sheetName}`;
        }
        
        /**
         * Sorts filtered data by the specified column.
         * @param {string} column - The column key to sort by.
         */
        function sortData(column) {
            // Determine the new sorting direction
            if (currentSortColumn === column) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortColumn = column;
                currentSortDirection = 'asc';
            }
        
            const directionMultiplier = currentSortDirection === 'asc' ? 1 : -1;
        
            filteredEmployeeData.sort((a, b) => {
                const aVal = a[column];
                const bVal = b[column];
        
                // Handle null/undefined values
                if (aVal === undefined || aVal === null) return 1 * directionMultiplier;
                if (bVal === undefined || bVal === null) return -1 * directionMultiplier;
        
                // Try numeric comparison
                const aNum = Number(aVal);
                const bNum = Number(bVal);
        
                if (!isNaN(aNum) && !isNaN(bNum) && typeof aVal !== 'string' && typeof bVal !== 'string') {
                    if (aNum < bNum) return -1 * directionMultiplier;
                    if (aNum > bNum) return 1 * directionMultiplier;
                }
        
                // Case-insensitive string comparison
                const aStr = String(aVal).toLowerCase();
                const bStr = String(bVal).toLowerCase();
        
                if (aStr < bStr) return -1 * directionMultiplier;
                if (aStr > bStr) return 1 * directionMultiplier;

                return 0; // Equal values
            });
            
            // Re-render the table with sorted data
            renderTable(filteredEmployeeData);
        }

        // --- FUNCIONES AUXILIARES DE FORMATO ---

        /**
         * Formats a national ID number (Cédula) with dots as thousands separators.
         * @param {string|number} value - The ID value.
         * @returns {string} Formatted ID.
         */
        function formatNumberWithDots(value) {
            if (value === null || value === undefined) return '';
            // Ensure it's a string and remove non-digit characters
            const str = String(value).replace(/\D/g, ''); 
            return str.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        }

        /**
         * Formats a date value (expected as 'YYYY-MM-DD' string or similar) to DD/MM/YYYY.
         * @param {string|number} value - The date value.
         * @returns {string} Formatted date.
         */
        function formatDate(value) {
            if (!value) return '';
            try {
                // Try to create a date object
                const date = new Date(value);
                if (isNaN(date.getTime())) {
                    return String(value); // Return original value if not a valid date
                }
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                return `${day}/${month}/${year}`;
            } catch (e) {
                return String(value);
            }
        }
        
        // --- FUNCIÓN DE RENDERIZADO DE TABLA ---
        
        /**
         * Renders the employee data table into the designated container.
         * @param {Array<Object>} data - The employee data to display.
         */
        function renderTable(data) {
            const container = document.getElementById('employee-table-container');
            if (!container) return;
            
            if (data.length === 0) {
                container.innerHTML = `<p class="text-center py-4 text-gray-400">No se encontraron registros que coincidan con la búsqueda.</p>`;
                return;
            }
            
            const narrowIdWidth = "30px";
            
            let tableHtml = `
                <table class="w-full">
                    <thead>
                        <tr>
                            <th class="sticky-id-cell p-3" style="min-width: ${narrowIdWidth}; max-width: ${narrowIdWidth};">ID</th>
                            ${TABLE_COLUMNS.map(col => {
                                let sortIcon = '';
                                if (currentSortColumn === col.key) {
                                    // Use currentSortDirection, which is globally defined
                                    const iconName = currentSortDirection === 'asc' ? 'arrow-up' : 'arrow-down'; 
                                    sortIcon = `<i data-lucide="${iconName}" class="w-3 h-3 text-white"></i>`;
                                }
                                // NOTE: Header text is already uppercase via CSS rule 'text-transform: uppercase;'
                                return `<th class="sortable-header" data-key="${col.key}">
                                        <div class="header-content">
                                            <span>${col.label}</span>
                                            ${sortIcon}
                                        </div>
                                    </th>`;
                            }).join('')}
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            data.forEach((row, index) => {
                // Try to use ID, otherwise use index + 1
                const rowId = row.ID !== undefined && row.ID !== null ? row.ID : (index + 1); 
                const hasWarning = row.CTRL1 && String(row.CTRL1).trim() !== '';
                const isBaja = row.PERFIL && String(row.PERFIL).trim().toUpperCase() === 'DADO DE BAJA';

                let classToAdd = '';
                    if (hasWarning) {
                        classToAdd = 'row-warning-text';
                    } else if (isBaja) {
                        classToAdd = 'row-alert-text';
                    }
                tableHtml += `
                    <tr class="worker-row ${classToAdd} hover:bg-gray-700/50" data-index="${index}" data-nomina="${row.NOMINA}">
                        <td class="table-data-cell sticky-id-cell" style="min-width: ${narrowIdWidth}; max-width: ${narrowIdWidth};">${rowId}</td>
                        ${TABLE_COLUMNS.map(col => {
                            const value = row[col.key] || '';
                            let formattedValue = String(value); 
                            
                            if (col.key === 'CEDULA') {
                                formattedValue = formatNumberWithDots(value);
                            } else if (col.key === 'INGRESO' || col.key === 'NACIMIENTO') {
                                formattedValue = formatDate(value);
                            }
                            
                            let alignmentClass;
                            // Cell alignment classes for TD
                            if (col.key === 'EMPRESA') {
                                // 1. EMPRESA: Center alignment
                                alignmentClass = 'text-center px-2 font-semibold';
                            } else if (['NOMBRES', 'APELLIDOS', 'PERFIL', 'SECTOR', 'UNIDAD', 'CARGO'].includes(col.key)) {
                                // 2. Left-aligned columns
                                alignmentClass = 'text-left px-2';
                            } else if (col.key === 'CTRL2') { 
                                // 3. Days of Vacation (Numbers) Right-aligned
                                alignmentClass = 'text-right px-2 font-semibold';
                            } else {
                                // 4. The rest (CEDULA, NOMINA, INGRESO) centered by default
                                alignmentClass = 'text-center px-1';
                            }
                            
                            return `<td class="table-data-cell ${alignmentClass}">${formattedValue}</td>`;
                        }).join('')}
                    </tr>
                `;
            });
            
            tableHtml += `</tbody></table>`;
            container.innerHTML = tableHtml;
            
            lucide.createIcons();
            
            initializeTableListeners();
        }

        /**
         * Initializes table action listeners (e.g., header click).
         */
        function initializeTableListeners() {
            // Assign listeners to headers for sorting
            document.querySelectorAll('.sortable-header').forEach(header => {
                header.addEventListener('click', function() {
                    const columnKey = this.getAttribute('data-key');
                    if (columnKey) {
                        sortData(columnKey);
                    }
                });
            });

            // Add listeners to rows for details (implementation pending)
            document.querySelectorAll('.worker-row').forEach(row => {
                row.addEventListener('click', function() {
                    const index = this.getAttribute('data-index');
                    const nomina = this.getAttribute('data-nomina');
                    console.log(`Fila clickeada: Índice ${index}, Nómina ${nomina}`);
                    // Logic to open employee detail view goes here
                });
            });
        }

        /**
         * Updates main metrics based on loaded data.
         * Counts: Total Records, 'Dados de Baja' (PERFIL = 'DADO DE BAJA'), and Warnings (CTRL1 not empty).
         * @param {Array<Object>} allData - All records loaded from the DB.
         */
        function updateMetrics(allData) {
            // Initialize counters
            let totalRecords = 0;
            let dadosDeBajaCount = 0;
            let warningCount = 0;

            // Process data
            if (Array.isArray(allData)) {
                totalRecords = allData.length;
                
                allData.forEach(row => {
                    // Count 'Dados de Baja' (PERFIL)
                    if (row.PERFIL && String(row.PERFIL).trim().toUpperCase() === 'DADO DE BAJA') {
                        dadosDeBajaCount++;
                    }
                    
                    // Count Warnings/Alerts (CTRL1)
                    if (row.CTRL1 && String(row.CTRL1).trim() !== '') {
                        warningCount++;
                    }
                });
            }

            // Map metrics to IDs
            const metricsMap = {
                'total': totalRecords,
                'perfil_dados_baja': dadosDeBajaCount,
                'ctrl1_warning': warningCount,
            };

            // Update DOM
            for (const [metricKey, value] of Object.entries(metricsMap)) {
                const metricElement = document.querySelector(`[data-metric="${metricKey}"]`);
                if (metricElement) {
                    metricElement.textContent = value;
                }
            }
        }

        /**
         * Filters the employee list based on the search text.
         * @param {string} searchTerm - The search term.
         */
        function filterEmployees(searchTerm) {
            const query = String(searchTerm).trim().toLowerCase();
            
            if (query === '') {
                // If search is empty, show all data and update metrics
                filteredEmployeeData = [...allEmployeeData];
            } else {
                // Filter data
                filteredEmployeeData = allEmployeeData.filter(employee => {
                    // Important search fields
                    const searchFields = [
                        'NOMBRES', 'APELLIDOS', 'CEDULA', 'CARGO', 'NOMINA', 'SECTOR', 'UNIDAD'
                    ];

                    return searchFields.some(field => 
                        String(employee[field] || '').toLowerCase().includes(query)
                    );
                });
            }
            
            // Re-render and update metrics with filtered data
            updateMetrics(filteredEmployeeData);
            renderTable(filteredEmployeeData);
        }
        
        /**
         * Clears the search field and resets the table.
         */
        function clearSearch() {
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
                searchInput.value = '';
                filterEmployees(''); // Reset filter
            }
        }
        
        /**
         * Reloads data from the data source (GAS), forcing cache bypass.
         */
        async function reloadData() {
            await loadData(true); // Pass 'true' to force reload
            // Clear filter after reload
            clearSearch();
        }


        /**
         * Loads data from local cache or Google Apps Script.
         * @param {boolean} forceReload - If true, bypasses local cache.
         */
        async function loadData(forceReload = false) {
            const statusElement = document.getElementById('table-loading-status');
            const dataViewContainer = document.getElementById('data-view-container');
            const mainTableWrapper = document.getElementById('employee-table-wrapper'); 
            const collapsibleContent = document.getElementById('collapsible-content');
            const tableContainer = document.getElementById('employee-table-container');
            
            // Initialize metrics to "..." before loading
            document.querySelectorAll('[data-metric]').forEach(el => el.textContent = '...');


            // Show spinner and hide content
            if (statusElement) {
                statusElement.innerHTML = `
                    <div class="py-8">
                        <i data-lucide="loader-circle" class="w-8 h-8 mx-auto animate-spin text-blue-500"></i> 
                        <p class="mt-2 text-sm text-gray-400">Cargando datos de la hoja "${TARGET_SHEET_NAME}"...</p>
                    </div>
                `;
                statusElement.style.display = 'block';
            }
            if (dataViewContainer) dataViewContainer.style.display = 'none';
            if (mainTableWrapper) mainTableWrapper.style.display = 'none'; 
            if (tableContainer) tableContainer.innerHTML = ''; 
            if (collapsibleContent) collapsibleContent.style.opacity = 0.5; 
            
            lucide.createIcons(); 

            const cachedData = localStorage.getItem(CACHE_KEY);
            if (cachedData && !forceReload) { // Check cache only if reload is NOT forced
                try {
                    const parsedCache = JSON.parse(cachedData);
                    const now = new Date().getTime();
                    
                    // Verify if cache is still valid (15 minutes)
                    if (now < parsedCache.expiry && Array.isArray(parsedCache.data)) {
                        console.log("Cargando datos desde el CACHÉ local (Válido por 15 minutos).");
                        const dataToUse = parsedCache.data;
                        allEmployeeData = dataToUse;
                        filteredEmployeeData = [...dataToUse];
                        
                        // Hide loading status and show main content
                        if (statusElement) statusElement.style.display = 'none';
                        if (dataViewContainer) dataViewContainer.style.display = 'block';
                        if (mainTableWrapper) mainTableWrapper.style.display = 'block'; 
                        if (collapsibleContent) collapsibleContent.style.opacity = 1;

                        updateMetrics(filteredEmployeeData);
                        renderTable(filteredEmployeeData); // Call actual rendering function
                        
                        return; // Successful cache load!
                    } else {
                        console.log("Caché expirado o no válido. Recuperando datos nuevos.");
                        localStorage.removeItem(CACHE_KEY); // Clear expired cache
                    }
                } catch (e) {
                    console.error("Error al parsear el caché local:", e);
                    localStorage.removeItem(CACHE_KEY); // Clear corrupt cache
                }
            }
            
            // If no valid cache or force reload, get data from GAS
            try {
                if (forceReload) {
                    console.log("Cargando datos frescos (Caché omitido/limpiado).");
                }
                const apiUrl = buildGasApiUrl(TARGET_SHEET_NAME);
                
                const response = await fetch(apiUrl, {
                    method: 'GET',
                });

                if (!response.ok) {
                    throw new Error(`Error de red: ${response.status} ${response.statusText || 'Error desconocido'}`);
                }

                const result = await response.json();
                let data = result;

                if (result && result.data && Array.isArray(result.data)) {
                    data = result.data;
                } else if (!Array.isArray(result)) {
                    throw new Error("Formato de datos no válido. Se esperaba un array JSON o un objeto con la propiedad 'data' (array).");
                }
                
                // Hide loading status and show main content
                if (statusElement) statusElement.style.display = 'none';
                if (dataViewContainer) dataViewContainer.style.display = 'block';
                if (mainTableWrapper) mainTableWrapper.style.display = 'block'; 
                if (collapsibleContent) collapsibleContent.style.opacity = 1;


                if (data.length === 0) {
                    if (statusElement) {
                        statusElement.innerHTML = '<div class="text-center py-8 text-gray-500 dark:text-gray-400">No se encontraron registros.</div>';
                        statusElement.style.display = 'block'; // Show "no records" message
                    }
                    if (dataViewContainer) dataViewContainer.style.display = 'none';
                    if (mainTableWrapper) mainTableWrapper.style.display = 'none';
                    updateMetrics([]);
                } else {
                    allEmployeeData = data;
                    filteredEmployeeData = [...data]; // Initially, all data is filtered

                    // Save to cache only if load was successful
                    const expiry = new Date().getTime() + CACHE_EXPIRATION_MS;
                    const cacheObject = { data: data, expiry: expiry };
                    localStorage.setItem(CACHE_KEY, JSON.stringify(cacheObject));
                    console.log("Nuevos datos obtenidos y guardados en caché (expira en 15 minutos).");
                    
                    updateMetrics(filteredEmployeeData);
                    renderTable(filteredEmployeeData); // Call actual rendering function
                }

            } catch (error) {
                console.error("Fallo al obtener los datos:", error);
                
                // Show error message in status container
                if (statusElement) {
                    statusElement.innerHTML = `
                        <div class="bg-red-800 p-4 rounded-xl shadow-lg text-white mt-4">
                            <strong class="font-bold">Error de Carga:</strong>
                            <p class="mt-1 text-sm">No se pudo cargar la información de ${TARGET_SHEET_NAME}.</p>
                            <p class="mt-1 text-xs opacity-80">Detalles: ${error.message}</p>
                            <p class="mt-2 text-xs opacity-80">Verifique la URL del Script y el despliegue (CORS).</p>
                        </div>
                    `;
                    statusElement.style.display = 'block';
                    lucide.createIcons();
                }
                if (dataViewContainer) dataViewContainer.style.display = 'none';
                if (mainTableWrapper) mainTableWrapper.style.display = 'none'; // Ensure table is not shown on error
                if (collapsibleContent) collapsibleContent.style.opacity = 1;
                updateMetrics([]); // Clear metrics on error
            }
        }
        
        // =================================================================
        // --- FUNCIONES DE NAVEGACIÓN Y UI ---
        // =================================================================

        // Main function to load section content and handle MPA navigation
        function loadContent(section) {
            console.log("Navegando a la sección:", section);

            // Redirection to individual HTML files.
            const navigationMap = {
                'Inicio': 'Inicio.html',
                'Vacaciones': 'Vacaciones.html', 
                'Agregar': 'AgregarDat.html',
                'Perfil': 'PerfilUser.html',
                'Configuración': 'ConfigApp.html'
            };

            const targetFile = navigationMap[section];

            if (targetFile) {
                if (section === 'Inicio') {
                    // If already on Inicio.html, force a data reload without cache
                    reloadData(); 
                    return;
                }
                
                window.location.href = targetFile;
                return; 
            }
            
            console.error(`ERROR: Sección no mapeada para navegación: ${section}`);
        }
        
        // Function to expand or collapse content
        function toggleCollapsibleContent() {
            const content = document.getElementById('collapsible-content');
            const toggleText = document.getElementById('toggle-text');
            const toggleIcon = document.getElementById('toggle-icon');
            const button = document.getElementById('toggle-content-btn');
            
            const isCollapsed = content.style.maxHeight === '0px' || content.style.maxHeight === '';

            if (isCollapsed) {
                // Expand
                // NOTE: It is important to recalculate scrollHeight before expanding
                content.style.maxHeight = content.scrollHeight + "px";
                content.style.marginTop = '1.5rem'; 
                toggleText.textContent = 'Contraer Detalles';
                toggleIcon.setAttribute('data-lucide', 'chevrons-up');
                
                button.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                button.classList.add('bg-gray-700', 'hover:bg-gray-600');
                
            } else {
                // Collapse
                // Set current height to start the smooth transition
                content.style.maxHeight = content.scrollHeight + "px"; 
                setTimeout(() => {
                    content.style.maxHeight = '0px';
                    content.style.marginTop = '0rem'; 
                }, 10);

                toggleText.textContent = 'Expandir Detalles';
                toggleIcon.setAttribute('data-lucide', 'chevrons-down');
                
                button.classList.remove('bg-gray-700', 'hover:bg-gray-600');
                button.classList.add('bg-blue-600', 'hover:bg-blue-700');
            }
            
            lucide.createIcons(); 
        }

        /**
         * Initializes DOM listeners specific to the Home page (search, reload).
         */
        function initializeHomeListeners() {
            const searchInput = document.getElementById('search-input');
            const clearBtn = document.getElementById('clear-search-btn');
            const reloadBtn = document.getElementById('reload-icon');
            
            // Listener for search field with Debounce (300ms)
            if (searchInput) {
                searchInput.addEventListener('input', () => {
                    clearTimeout(debounceTimer);
                    debounceTimer = setTimeout(() => {
                        filterEmployees(searchInput.value);
                    }, 300);
                });
            }

            // Listener for clear search button
            if (clearBtn) {
                clearBtn.addEventListener('click', clearSearch);
            }

            // Listener for reload data button (bypasses cache)
            if (reloadBtn) {
                reloadBtn.addEventListener('click', reloadData);
            }
            
            // tableListeners are called within renderTable
        }
        
        // --- APPLICATION INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            // Logic to display only the user's first name if available in localStorage
            const usuarioNombreCompleto = localStorage.getItem('Usuario_Nombre');
            const headerTitle = document.querySelector('#app-header h1');
            
            if (usuarioNombreCompleto && headerTitle) {
                // Extract first name and capitalize first letter
                const primerNombre = usuarioNombreCompleto.trim().split(' ')[0];
                const capitalizedFirstName = primerNombre.charAt(0).toUpperCase() + primerNombre.slice(1).toLowerCase();
                
                headerTitle.textContent = `¡Hola, ${capitalizedFirstName}!`;
            }

            // Start loading data from Google Sheet
            loadData();
            
            // Initialize UI listeners (search, reload)
            initializeHomeListeners();

            // Add event listeners for MPA navigation
            const footerButtons = document.querySelectorAll('.footer-btn');
            footerButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const section = button.getAttribute('data-section');
                    loadContent(section);
                });
            });
            
            // Attach event listener to the collapse button
            const toggleButton = document.getElementById('toggle-content-btn');
            const content = document.getElementById('collapsible-content');
            
            if (toggleButton && content) {
                toggleButton.addEventListener('click', toggleCollapsibleContent);
                // Ensure content is fully expanded on load
                setTimeout(() => {
                    // Only initialize collapsible state after DOM is ready
                    content.style.maxHeight = content.scrollHeight + "px";
                    lucide.createIcons();
                }, 100);
            }

            // Re-initialize icons on load
            lucide.createIcons();
        });
        
    </script>
</body>
</html>
