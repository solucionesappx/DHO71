<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vacaciones - Carga desde GAS</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga de Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        /* Configuración de Tailwind para usar el color de acento y la fuente Inter  */
        html {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent; 
        }

        /* Definición de colores base para modo claro y oscuro */
        :root {
            --color-bg-light: #f9fafb;
            --color-text-light: #1f2937;
            --color-primary-light: #3b82f6;
            --color-bg-dark: #1f2937;
            --color-text-dark: #f3f4f6;
            --color-primary-dark: #60a5fa;
            --color-surface-light: #ffffff;
            --color-surface-dark: #374151;
            
            --color-header: #2D59A1; 
            --color-data-text: #ffffff;
            
            /* Altura de referencia para alinear el modal y la tarjeta de bienvenida (Header + Padding) */
            --header-offset: 76px; 
            --footer-height: 72px; 
            
            --color-row-hover: #15803d; 
            --color-row-selected: #1e8749; 
            --color-warning: #ef4444; 
        }
        
        /* Estilos del cuerpo en modo claro y oscuro */
        .light {
            background-color: var(--color-bg-light);
            color: var(--color-text-light);
        }
        .dark {
            background-color: var(--color-bg-dark);
            color: var(--color-text-dark);
        }
        
        #app-container {
            max-width: 500px;
            margin: 0 auto;
            min-height: 10vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
            position: relative; 
            overflow: hidden; 
        }

        header, footer {
            width: 100%;
            max-width: 500px; 
            z-index: 50; 
            transition: background-color 0.3s, color 0.3s;
            left: 50%;
            transform: translateX(-50%);
        }

        .light header, .light footer {
            background-color: var(--color-surface-light);
            border-color: #e5e7eb;
        }
        .dark header, .dark footer {
            background-color: var(--color-surface-dark);
            border-color: #4b5563;
        }

        /* AJUSTE: Padding del main para dejar espacio al header y footer */
        main {
            flex-grow: 1;
            overflow-y: auto; 
            padding: 1rem; 
            padding-top: var(--header-offset);
            padding-bottom: var(--footer-height);
            transition: padding 0.3s ease-in-out;
        }
        
        .footer-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px 4px;
            font-size: 0.75rem; 
            line-height: 1;
            transition: color 0.2s, background-color 0.2s;
            border-radius: 0.5rem;
            color: inherit; 
        }

        .footer-btn.active {
            color: var(--color-primary-dark);
        }
        .light .footer-btn.active {
             color: var(--color-primary-light);
        }
        
        /* * ESTILO ESPECÍFICO PARA LA TABLA DE DATOS * */

        .table-scroll-container {
            max-height: 450px; 
            overflow-x: auto; 
            overflow-y: auto; 
            border-radius: 0.75rem; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            display: block; 
        }
        
        .table-scroll-container table {
            table-layout: auto; 
            width: max-content; 
            min-width: 100%; 
        }
        
        .table-scroll-container th {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: var(--color-header); 
            color: var(--color-data-text);
            padding: 0.5rem; 
            text-align: center; 
            white-space: nowrap;
        }

        .sort-icon-lucide {
            display: inline-block;
            margin-left: 0.25rem;
            width: 16px; 
            height: 16px;
            vertical-align: middle;
            opacity: 0.9;
        }
        
        .table-data-cell {
            font-size: 0.875rem; 
            padding-top: 0.25rem; 
            padding-bottom: 0.25rem;
            white-space: nowrap; 
            transition: background-color 0.15s, color: 0.15s, border-color 0.15s;
        }

        .light .table-data-cell {
            color: var(--color-text-light);
            border-bottom: 1px solid #e5e7eb; 
            background-color: var(--color-surface-light); 
        }

        .dark .table-data-cell {
            color: var(--color-text-dark);
            border-bottom: 1px solid var(--color-surface-dark); 
            background-color: var(--color-bg-dark); 
        }
        
        .row-warning-text td {
            color: var(--color-warning) !important;
        }
        .row-warning-text:hover td {
            color: #ffffff !important; 
        }

        .sticky-id-cell {
            position: sticky;
            left: 0;
            background-color: var(--color-header) !important; 
            color: var(--color-data-text) !important; 
            border-right: 1px solid rgba(255, 255, 255, 0.2); 
            font-weight: bold;
            text-align: center;
        }

        .sticky-id-cell.header {
            top: 0;
            z-index: 20; 
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1); 
        }
        
        .sortable-header {
            cursor: pointer;
            user-select: none;
            transition: background-color 0.1s;
        }

        .sortable-header:hover {
            background-color: rgba(255, 255, 255, 0.1); 
        }
        
        .worker-row:hover td {
            background-color: var(--color-row-hover) !important;
            color: #ffffff !important; 
            cursor: pointer; 
            border-bottom-color: var(--color-row-hover) !important; 
        }

        .worker-row.selected-row td {
            background-color: var(--color-row-selected) !important;
            color: #ffffff !important; 
            border-bottom-color: var(--color-row-selected) !important; 
        }

        .worker-row:hover td.sticky-id-cell,
        .worker-row.selected-row td.sticky-id-cell {
            background-color: var(--color-row-hover) !important;
            border-right: 1px solid rgba(255, 255, 255, 0.4) !important; 
        }

        /* --- ESTILOS DEL MODAL FIJO Y ALINEADO --- */
        .modal-overlay {
            position: fixed; /* Usar fixed para asegurar que cubra todo el viewport */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6); 
            display: none; 
            justify-content: center;
            align-items: flex-start; /* Alineación arriba para permitir el posicionamiento */
            z-index: 999; /* Alto z-index */
            overflow-y: auto;
            padding-top: 10px; /* Pequeño padding arriba */
        }
        
        /* Contenedor del modal */
        #vacation-modal-content-wrapper {
            position: absolute; 
            width: 90%; 
            max-width: 450px; /* Ancho máximo para el detalle */
            transition: transform 0.3s, opacity 0.3s;
            /* La posición 'top' se calculará en JS */
        }
        
        /* Estilo para el botón de navegación deshabilitado */
        .disabled-nav {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .concepto-scroll {
         /* 1. Evita que el texto se ajuste a la siguiente línea */
        white-space: nowrap;

        /* 2. Agrega una barra de desplazamiento horizontal si el contenido es demasiado largo */
        overflow-x: auto;

        /* 3. Se recomienda establecer un ancho máximo visible para que overflow-x se active */
        max-width: 200px; /* Ajusta este valor según el ancho de columna deseado */
}
        
    </style>
</head>
<body class="dark transition-colors duration-300"> 

    <div id="app-container" class="shadow-xl">
        
        <!-- Encabezado Fijo -->
        <header id="app-header" class="fixed top-0 w-full h-14 border-b border-gray-700 dark:border-gray-500 flex items-center justify-between px-4">
            <h1 class="text-xl font-bold cursor-pointer hover:opacity-80 transition-opacity" onclick="window.location.href = 'inicio.html'">
                Mi Aplicación Móvil
            </h1>
            <div class="flex space-x-3">
                <button class="p-2 rounded-full hover:opacity-80 transition-opacity" onclick="window.location.href = 'index.html'">
                    <i data-lucide="log-out" class="w-6 h-6 text-red-400 dark:text-red-300"></i>
                </button>
            </div>
        </header>

        <!-- Contenido Principal con Scroll. -->
        <main id="main-content" class="flex flex-col space-y-4">
            <!-- El contenido de la sección 'Vacaciones' se inyectará aquí. -->
        </main>

        <!-- Footer de Navegación Fijo -->
        <footer id="app-footer" class="fixed bottom-0 w-full h-18 border-t border-gray-700 dark:border-gray-500 flex items-center justify-around py-2">
            <button class="footer-btn" data-section="Inicio">
                <i data-lucide="home" class="w-6 h-6"></i>
                <span>Inicio</span>
            </button>
            <button class="footer-btn active" data-section="Vacaciones">
                <i data-lucide="calendar-days"> class="w-6 h-6"></i>
                <span>Vacaciones</span>
            </button>
            <button class="footer-btn" data-section="Agregar">
                <i data-lucide="calendar-plus" class="w-6 h-6"></i>
                <span>Agregar</span>
            </button>
            <button class="footer-btn" data-section="Editar">
                <i data-lucide="edit" class="w-6 h-6"></i>
                <span>Editar</span>
            </button>
            <button class="footer-btn" data-section="Perfil">
                <i data-lucide="user" class="w-6 h-6"></i>
                <span>Perfil</span>
            </button>
            <button class="footer-btn" data-section="Configuración">
                <i data-lucide="settings" class="w-6 h-6"></i>
                <span>Config</span>
            </button>
        </footer>

        
        <!-- MODAL DE DETALLE DE VACACIONES -->
        <div id="VacationDetailModal" class="modal-overlay" onclick="closeVacationModal(event)">
            <div id="vacation-modal-content-wrapper" 
                 class="mx-auto" 
                 onclick="event.stopPropagation()">
                
                <div class="bg-gray-800 p-6 rounded-xl shadow-2xl w-full dark:bg-gray-700">
                    
                    <!-- Encabezado del Modal -->
                    <div class="flex justify-between items-center pb-3 mb-4">
                        <h3 class="text-xl font-bold text-yellow-400">Detalle de Absentismo</h3>
                        <!-- Botón de Cierre -->
                        <button onclick="closeVacationModal()" class="p-1 rounded-full text-red-400 hover:text-red-600 transition duration-150">
                            <i data-lucide="x" class="w-6 h-6"></i> 		
                        </button>
                    </div>
                    
                    <!-- Contador y Navegación -->
                    <div class="flex justify-between items-center mb-4">
                        <!-- Botón Anterior -->
                        <button id="prev-record-btn" onclick="navigateRecord(-1)" class="p-2 rounded-full bg-gray-600 hover:bg-gray-500 text-white transition disabled-nav">
                            <i data-lucide="chevron-left" class="w-4 h-4"></i>
                        </button>

                        <!-- Registro X de Y -->
                        <span id="registro-count" class="text-sm font-semibold text-yellow-300">
                            Registro X de Y
                        </span>

                        <!-- Botón Siguiente -->
                        <button id="next-record-btn" onclick="navigateRecord(1)" class="p-2 rounded-full bg-gray-600 hover:bg-gray-500 text-white transition disabled-nav">
                            <i data-lucide="chevron-right" class="w-4 h-4"></i>
                        </button>
                    </div>

                    <!-- Campos de Detalle del Registro -->
                    <div class="grid grid-cols-2 gap-x-4 gap-y-3 p-4 bg-gray-700 rounded-lg text-sm">
                        
                        <!-- 1. Período -->
                        <div class="col-span-2 flex flex-col">
                            <span class="text-xs font-medium uppercase text-gray-400">Período</span>
                            <span id="detail-periodo" class="text-base font-semibold text-white"></span>
                        </div>
                        
                        <!-- 2. Concepto -->
                        <div class="col-span-2 flex flex-col">
                            <span class="text-xs font-medium uppercase text-gray-400">Concepto</span>
                            <span id="detail-concepto" class="text-base font-semibold text-white"></span>
                        </div>
                        
                        <!-- 3. Días -->
                        <div class="flex flex-col border-r border-gray-600 pr-4">
                            <span class="text-xs font-medium uppercase text-gray-400">Días Vacaciones</span>
                            <span id="detail-dias" class="text-base font-semibold text-white"></span>
                        </div>
                        
                        <!-- 4. Bono -->
                        <div class="flex flex-col">
                            <span class="text-xs font-medium uppercase text-gray-400">Bono Vacacional</span>
                            <span id="detail-bono" class="text-base font-semibold text-green-400"></span>
                        </div>
                        
                    </div>
                    
                </div>
            </div>
        </div>
        <!-- Fin MODAL DE DETALLE DE VACACIONES -->

    </div>

    <script>
        // --- CONSTANTES Y VARIABLES GLOBALES ---
        
        // Simulación de la URL de la API de Google Apps Script
        const BASE_GAS_API_URL = 'https://script.google.com/macros/s/AKfycbx87WvxA9ca1KyGMA1wsw1npZw5vPtjoItomhF823BICXScNrWGFh5m0Dj6Veb24CtHXQ/exec';
        
        // Constantes ajustadas para la función loadData:
        const CACHE_VAC_KEY = 'vacacionesDataCache';
        const CACHE_EXPIRATION_MS = 900000; // 15 minutos   

        const VACACIONES_COLUMNS = [
            { key: 'PERIODO', label: 'Período', sortable: true },
            { key: 'DESCRIPCION_CONCEPTO', label: 'Concepto', sortable: true },
            { key: 'DIAS_VACACIONES', label: 'Días', sortable: true },
            { key: 'BONO_VACACIONAL', label: 'Bono', sortable: true },
        ];
        
        const SECTION_CONFIG = {
            'Vacaciones': { 
                sheetName: 'Vacaciones', 
                columns: VACACIONES_COLUMNS,
                tableContainerId: 'employee-table-container', 
            },
        };
       
        // --- LÓGICA DE CARGA DE DATOS DEL EMPLEADO (LOCALSTORAGE/MOCK) ---
        const EMPLOYEE_TRANSFER_KEY = 'userInfoToEdit';

        /**
         * Carga la información del empleado desde localStorage (si existe y es válida) 
         * o usa la información mock por defecto.
         */
        function getEmployeeInfo() {
            const defaultInfo = {
                CEDULA: 13105322, 
                INGRESO: '13/10/2015',
                NOMBRES: 'NOMBRE TRABAJADOR',
                APELLIDOS: 'APELLIDO TRABAJADOR',
            };
            
            try {
                const cachedData = localStorage.getItem(EMPLOYEE_TRANSFER_KEY);
                if (cachedData) {
                    const employeeInfo = JSON.parse(cachedData);
                    console.log("✅ Datos del empleado cargados desde localStorage:", employeeInfo);
                    // Asegurar que usamos al menos la cédula, y combinar con el mock en caso de faltar datos
                    if (employeeInfo && employeeInfo.CEDULA) {
                        return { ...defaultInfo, ...employeeInfo }; 
                    }
                }
            } catch (error) {
                // Si hay un error de parseo o lectura, caemos al valor por defecto
                console.error("Error al parsear los datos del empleado desde localStorage, usando mock:", error);
            }
            
            console.log("❌ Usando datos mock por defecto.");
            return defaultInfo;
        }

        const MOCK_EMPLOYEE_INFO = getEmployeeInfo();
        let TARGET_CEDULA = MOCK_EMPLOYEE_INFO.CEDULA; // Cédula del trabajador actual
        
        let filteredEmployeeData = []; // Datos que se muestran en la tabla (filtrados por cédula y búsqueda)
        let userBaseData = []; // Base de datos del usuario filtrada por Cédula (para aplicar filtros).
        let currentSheet = 'Vacaciones'; 

        // Variables de estado para el ordenamiento
        let currentSortColumn = null; 
        let sortOrder = 'asc'; 
        
        // Variables de estado para el modal de detalle
        let currentRecordIndex = -1; // Índice del registro actual en filteredEmployeeData

        // --- FUNCIONES AYUDANTES DE FORMATO ---

        function buildGasApiUrl(sheetName) {
            const url = new URL(BASE_GAS_API_URL);
            url.searchParams.append('sheet', sheetName);
            return url.toString();
        }

        /** Formatea un número o string de cédula con puntos como separadores de miles. */
        function formatNumberWithDots(value) {
            if (value === null || value === undefined || value === '') return '';
            let numStr;
            const number = Number(value);
            if (!isNaN(number)) {
                numStr = String(Math.round(number));
            } else {
                numStr = String(value).replace(/\D/g, ''); 
            }
            return new Intl.NumberFormat('es-ES', { maximumFractionDigits: 0 }).format(Number(numStr));
        }
        
        function formatDate(value) {
            if (!value) return '';
            return String(value); 
        }

        // --- LÓGICA DE ORDENAMIENTO Y COMPARACIÓN ---

        function getNumericValue(value) {
            const num = Number(value);
            return isNaN(num) || value === '' ? 0 : Math.round(num); 
        }

        function compareValues(valA, valB, order, isNumeric = false) {
            if (isNumeric) {
                const numA = getNumericValue(valA);
                const numB = getNumericValue(valB);
                const comparison = numA - numB;
                return order === 'asc' ? comparison : -comparison;
            } else {
                let strA = String(valA || '').toLowerCase();
                let strB = String(valB || '').toLowerCase();
                
                let comparison = 0;
                if (strA > strB) { comparison = 1; } 
                else if (strA < strB) { comparison = -1; }
                
                return order === 'asc' ? comparison : -comparison;
            }
        }

        function sortData(key) {
            if (key) {
                if (currentSortColumn === key) {
                    sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSortColumn = key;
                    sortOrder = 'asc';
                }
            }

            filteredEmployeeData.sort((a, b) => {
                if (!key || key === 'CEDULA') {
                    // Orden de prioridad predeterminado
                    let comparison = compareValues(a.CEDULA, b.CEDULA, 'asc', true);
                    if (comparison !== 0) return comparison;

                    comparison = compareValues(a.PERIODO, b.PERIODO, 'desc', false);
                    if (comparison !== 0) return comparison;

                    comparison = compareValues(a.DESCRIPCION_CONCEPTO, b.DESCRIPCION_CONCEPTO, 'asc', false);
                    return comparison;
                } else {
                    let valA = a[key] !== undefined ? a[key] : '';
                    let valB = b[key] !== undefined ? b[key] : '';
                    const isNumeric = ['DIAS_VACACIONES', 'BONO_VACACIONAL'].includes(key) && valA !== '' && valB !== '';
                    
                    return compareValues(valA, valB, sortOrder, isNumeric);
                }
            });

            renderTable(filteredEmployeeData, SECTION_CONFIG[currentSheet].columns);
        }
        
        function updateSortIcons() {
            document.querySelectorAll('.sort-icon-lucide-container').forEach(container => {
                container.innerHTML = '';
            });

            if (currentSortColumn) {
                const iconContainer = document.getElementById(`sort-icon-container-${currentSortColumn}`);
                
                if (iconContainer) {
                    const iconName = sortOrder === 'asc' ? 'arrow-up' : 'arrow-down';
                    iconContainer.innerHTML = `
                        <i data-lucide="${iconName}" class="sort-icon-lucide w-4 h-4 text-white"></i>
                    `;
                    
                    if (typeof lucide !== 'undefined' && lucide.createIcons) {
                        lucide.createIcons();
                    }
                }
            }
        }

        /**
         * Renderiza la tarjeta de información del empleado con el nuevo diseño de 2x3 grids.
         */
        function renderEmployeeInfo() {
            const infoContainer = document.getElementById('employee-info-card');
            const data = MOCK_EMPLOYEE_INFO; 
            
            if (!infoContainer || !data) return;

            // EL CÁLCULO CLAVE: CALCULAR EL TOTAL DÍAS CON LOS DATOS FILTRADOS
            const totalDays = filteredEmployeeData.reduce((sum, row) => {
                const days = getNumericValue(row.DIAS_VACACIONES);
                return sum + days;
            }, 0);
            
            // CÁLCULOS ADICIONALES PARA LA NUEVA ESTRUCTURA (Días Positivos/Negativos)
            const diasAsignados = filteredEmployeeData.reduce((sum, row) => {
                const days = getNumericValue(row.DIAS_VACACIONES);
                return sum + (days > 0 ? days : 0); // Suma solo los días positivos (Asignaciones)
            }, 0);

            let diasConsumidos = filteredEmployeeData.reduce((sum, row) => {
                const days = getNumericValue(row.DIAS_VACACIONES);
                return sum + (days < 0 ? days : 0); // Suma solo los días negativos (Disfrutes)
            }, 0);
            // El campo Disfrutes Efectivos debe ser siempre negativo (ya está implementado aquí)
            
            let formattedName = 'Empleado Desconocido';
            if (data.NOMBRES && data.APELLIDOS) {
                const names = String(data.NOMBRES).trim().split(/\s+/);
                const firstName = names[0];
                const middleInitial = names.length > 1 ? names[1].charAt(0) + '.' : '';
                const surnames = String(data.APELLIDOS).trim().split(/\s+/);
                const firstSurname = surnames[0];
                const lastInitial = surnames.length > 1 ? surnames[1].charAt(0) + '.' : '';

                formattedName = `${firstName} ${middleInitial} ${firstSurname} ${lastInitial}`.replace(/\s{2,}/g, ' ').trim();
            }
            
            const formattedCedula = formatNumberWithDots(data.CEDULA);
            const formattedIngreso = formatDate(data.INGRESO);

            infoContainer.innerHTML = `
                <div id="worker-card" class="bg-[#2D59A1] p-4 rounded-xl shadow-lg dark:bg-gray-800/90">
                    
                    <!-- 1RA GRID (2 Columnas: Nombre | Cédula y Fecha Ingreso) -->
                    <div class="grid grid-cols-2 gap-4 pb-2 mb-2 border-b border-blue-800 dark:border-gray-700">
                        
                        <!-- Columna 1: Nombre del Trabajador (Formato destacado) -->
                        <div>
                            <h3 class="text-xl font-extrabold text-white leading-tight">
                                ${formattedName}
                            </h3>
                            <button class="p-1" title="Ver Detalle de Absentismo" onclick="showVacationDetailModal()">
                                <i data-lucide="calendar-plus" class="w-6 h-6 text-yellow-400"></i>
                            </button>
                        </div>
                        
                        <!-- Columna 2: Cédula y Fecha Ingreso (Alineado a la derecha) -->
                        <div class="text-right">
                            <div class="flex flex-col items-end">
                                <span class="text-sm text-white font-semibold">Cédula: ${formattedCedula}</span>
                                <span class="text-sm text-white font-semibold">Ingreso: ${formattedIngreso}</span>
                            </div>
                        </div>
                    </div>

                    <!-- 2DA GRID (3 Columnas: Asignación | Disfrutes | Total Días) -->
                    <div class="grid grid-cols-3 gap-2 text-center">
                        
                        <!-- Columna 1: Asignación Beneficio (Días > 0) -->
                        <div class="px-3 py-1 rounded-lg bg-green-500/80 shadow-inner flex flex-col items-center justify-center">
                            <i data-lucide="calendar-arrow-up" class="w-6 h-6 text-white mb-1"></i>
                            <span class="text-xs font-medium text-white block">Asignación</span>
                            <span class="text-xl font-bold text-white">${diasAsignados}</span>
                        </div>
                        
                        <!-- Columna 2: Disfrutes Efectivos (Días < 0, valor absoluto) -->
                        <div class="px-3 py-1 rounded-lg bg-red-500/90 shadow-inner flex flex-col items-center justify-center">
                            <i data-lucide="calendar-arrow-down" class="w-6 h-6 text-white mb-1"></i>
                            <span class="text-xs font-medium text-white block">Disfrute</span>
                            <span class="text-xl font-bold text-white">${diasConsumidos}</span>
                        </div>
                        
                        <!-- Columna 3: Total Días (Neto) -->
                        <div class="px-3 py-1 rounded-lg bg-gray-500/90 shadow-inner flex flex-col items-center justify-center">
                            <i data-lucide="calendar-check-2" class="w-6 h-6 text-white mb-1"></i>
                            <span class="text-xs font-medium text-white block">Total Días</span>
                            <span class="text-xl font-extrabold text-white">${totalDays}</span>
                        </div>
                        
                    </div>
                </div>
            `;
            
            if (typeof lucide !== 'undefined' && lucide.createIcons) {
                lucide.createIcons();
            }
        }

        // --- FUNCIONES PRINCIPALES DE DATOS Y FILTRADO ---

        /**
         * Carga los datos de la hoja activa desde la URL de Google Apps Script y aplica el filtro por Cédula.
         * @param {boolean} forceRefresh - Si es true, omite el caché.
         */
        async function loadData(forceRefresh = false) {
            
            const config = SECTION_CONFIG[currentSheet];
            if (!config) {
                console.log(`La sección "${currentSheet}" no requiere carga de datos de hoja.`);
                return;
            }
            
            const statusElement = document.getElementById('table-loading-status');
            const tableScrollWrapper = document.getElementById('table-scroll-wrapper');
            const tableContainer = document.getElementById(config.tableContainerId);

            if (statusElement) {
                statusElement.innerHTML = `
                    <div class="text-center py-10">
                        <i data-lucide="loader-circle" class="w-8 h-8 mx-auto animate-spin text-blue-400"></i> 
                        <p class="mt-2 text-sm text-gray-400">Cargando datos de la hoja "${currentSheet}"...</p>
                    </div>
                `;
                statusElement.style.display = 'block';
            }
            
            if (tableScrollWrapper) {
                if (tableContainer) tableContainer.innerHTML = '';
                tableScrollWrapper.style.display = 'none';
            } else if (tableContainer) {
                tableContainer.innerHTML = '';
            }

            if (typeof lucide !== 'undefined' && lucide.createIcons) {
                lucide.createIcons(); 
            }

            let allEmployeeData = [];
            let isDataCached = false;


            // --- 1. LECTURA Y VALIDACIÓN DEL CACHÉ (Solo para Vacaciones) ---
            if (currentSheet === 'Vacaciones' && !forceRefresh) {
                try {
                    const cachedData = localStorage.getItem(CACHE_VAC_KEY);
                    if (cachedData) {
                        const cache = JSON.parse(cachedData);
                        const now = new Date().getTime();
                        
                        if (now < cache.timestamp + CACHE_EXPIRATION_MS) {
                            allEmployeeData = cache.data;
                            isDataCached = true;
                            console.log("Datos de Vacaciones cargados desde el caché.");
                        } else {
                            console.log("Caché de Vacaciones expirado.");
                            localStorage.removeItem(CACHE_VAC_KEY);
                        }
                    }
                } catch (e) {
                    console.error("Error al leer o parsear el caché:", e);
                    localStorage.removeItem(CACHE_VAC_KEY);
                }
            }


            // --- 2. CARGA DESDE LA API (Si el caché no es válido) ---
            if (!isDataCached) {
                try {
                    const apiUrl = buildGasApiUrl(currentSheet); 
                    // Se usa fetch simple según solicitud.
                    const response = await fetch(apiUrl, { method: 'GET' }); 

                    if (!response.ok) {
                        throw new Error(`Error de red: ${response.status} ${response.statusText || 'Error desconocido'}`);
                    }

                    const result = await response.json();
                    let data = result;

                    if (result && result.data && Array.isArray(result.data)) {
                        data = result.data;
                    } else if (!Array.isArray(result)) {
                        throw new Error("Formato de datos no válido.");
                    }
                    
                    allEmployeeData = data;

                    // --- 3. ESCRITURA EN EL CACHÉ (Solo para Vacaciones) ---
                    if (currentSheet === 'Vacaciones') {
                        const cacheEntry = {
                            data: allEmployeeData,
                            timestamp: new Date().getTime()
                        };
                        localStorage.setItem(CACHE_VAC_KEY, JSON.stringify(cacheEntry));
                        console.log("Nuevos datos de Vacaciones guardados en caché.");
                    }
                    // --- FIN ESCRITURA EN EL CACHÉ ---
                    
                } catch (error) {
                    console.error(`Fallo al obtener los datos de ${currentSheet}:`, error);
                    if (statusElement) statusElement.style.display = 'none';
                    if (tableScrollWrapper) tableScrollWrapper.style.display = 'none';
                    return; // Salir si la API falló y no había datos en caché para usar
                }
            }

            // --- 4. PROCESAR Y RENDERIZAR DATOS (Tanto si vienen de caché como de la API) ---

            // 5. Aplicar FILTRO por TARGET_CEDULA
            if (TARGET_CEDULA !== null) {
                const targetNum = Number(TARGET_CEDULA);
                userBaseData = allEmployeeData.filter(row => {
                    const rowCedula = Number(row.CEDULA);
                    return rowCedula === targetNum;
                });
            } else {
                userBaseData = [...allEmployeeData];
            }
            
            // 6. Renderizar Info y Tabla
            renderEmployeeInfo();
            
            if (statusElement) statusElement.style.display = 'none';
            if (tableScrollWrapper) tableScrollWrapper.style.display = 'block';

            // Inicializar placeholder y aplicar filtros
            updateFilterPlaceholder();
            currentSortColumn = 'CEDULA';
            sortOrder = 'asc';
            applyAllFilters();
        }
        
        /**
         * Actualiza el placeholder del input de búsqueda y llama a aplicar filtros.
         */
        function updateFilterPlaceholder() {
            const searchInput = document.getElementById('search-input');
            const checkbox = document.getElementById('filterByPeriodCheckbox');
            
            if (!searchInput || !checkbox) return; // Asegurar que los elementos existan

            if (checkbox.checked) {
                searchInput.placeholder = "Solo Periodo";
            } else {
                searchInput.placeholder = "Periodo o Concepto";
            }
            // Re-aplicar el filtro inmediatamente después del cambio de modo
            applyAllFilters(); 
        }

        /**
         * Aplica todos los filtros (Búsqueda por Texto) a userBaseData y 
         * actualiza la interfaz (Total Días y Tabla).
         */
        function applyAllFilters() {
            const searchInput = document.getElementById('search-input');
            const checkbox = document.getElementById('filterByPeriodCheckbox');
            
            if (!searchInput || !checkbox) return; // Asegurar que los elementos existan

            const query = (searchInput.value || '').toLowerCase().trim();
            const filterByPeriodOnly = checkbox.checked;
            
            let tempFilteredData = [...userBaseData];
            
            // 1. Filtrar por Búsqueda de Texto
            if (query.length > 0) {
                tempFilteredData = tempFilteredData.filter(row => {
                    const periodo = String(row.PERIODO || '').toLowerCase();
                    const concepto = String(row.DESCRIPCION_CONCEPTO || '').toLowerCase();
                    
                    if (filterByPeriodOnly) {
                        // Filtrar SOLO por PERIODO
                        return periodo.includes(query);
                    } else {
                        // Filtrar por PERIODO O CONCEPTO
                        return periodo.includes(query) || concepto.includes(query);
                    }
                });
            }

            filteredEmployeeData = tempFilteredData;

            // 2. Renderizar componentes afectados
            renderEmployeeInfo(); // Actualiza el total de días (basado en filteredEmployeeData)
            sortData(currentSortColumn); // Re-ordena y renderiza la tabla
        }

        /**
         * Restaura los datos originales del usuario, limpia el campo de búsqueda y 
         * desactiva el filtro por periodo.
         */
        function clearSearchFilter() {
            const searchInput = document.getElementById('search-input');
            const checkbox = document.getElementById('filterByPeriodCheckbox');
            
            if (searchInput) {
                searchInput.value = '';
            }
            
            if (checkbox) {
                checkbox.checked = false; // Desactivar el filtro de periodo
            }

            updateFilterPlaceholder(); // Esto llama a applyAllFilters
        }


        /**
         * Renderiza la tabla en el contenedor.
         */
        function renderTable(data, columnsConfig) {
            
            const config = SECTION_CONFIG[currentSheet];
            const container = document.getElementById(config.tableContainerId);
            
            if (!container) return;
            if (data.length === 0) {
                container.innerHTML = `<p class="text-center py-4 text-gray-400">No se encontraron registros que coincidan con los filtros aplicados.</p>`;
                return;
            }
            
            const narrowIdWidth = "30px";
            let tableHtml = `
                <table class="border-collapse">
                    <thead>
                        <tr>
                            <th class="sticky-id-cell p-3 text-sm header" style="width: ${narrowIdWidth};">ID</th>
                            ${columnsConfig.map(col => {
                                const sortClass = 'sortable-header';
                                const sortClick = `onclick="sortData('${col.key}')"`;
                                
                                return `<th class="text-sm ${sortClass}" ${sortClick}><div class="flex items-center justify-center space-x-1"><span>${col.label}</span><div id="sort-icon-container-${col.key}" class="sort-icon-lucide-container"></div></div></th>`;
                            }).join('')}
                        </tr>
                    </thead>
                    <tbody id="vacation-table-body">
            `;
            
            // Genera las filas de datos
            data.forEach((row, index) => {
                const rowId = index + 1; 
                const hasWarning = row.CTRL1 && String(row.CTRL1).trim() !== '';

                tableHtml += `
                    <!-- IMPORTANTE: data-index almacena la posición del registro en filteredEmployeeData -->
                    <tr class="worker-row ${hasWarning ? 'row-warning-text' : ''}" data-id="${rowId}" data-index="${index}">
                        <td class="table-data-cell sticky-id-cell px-1 text-xs text-center" style="width: ${narrowIdWidth};">${rowId}</td>
                        ${columnsConfig.map(col => {
                            const value = row[col.key] || '';
                            let formattedValue = String(value);
                            let alignmentClass = 'text-center'; 
                            
                            if (col.key === 'BONO_VACACIONAL') {
                                alignmentClass = 'text-right'; 
                            } else if (col.key === 'DIAS_VACACIONES') {
                                alignmentClass = 'text-right'; 
                            } else if (col.key === 'DESCRIPCION_CONCEPTO') {
                                alignmentClass = 'text-left'; 
                            } else if (col.key === 'PERIODO') {
                                alignmentClass = 'text-center'; 
                            }
                            
                            const pxClass = 'px-1';
                            
                            return `<td class="table-data-cell ${alignmentClass} ${pxClass}">${formattedValue}</td>`;
                        }).join('')}
                    </tr>
                `;
            });
            
            tableHtml += `</tbody></table>`;
            container.innerHTML = tableHtml;
            
            updateSortIcons();
            
            // Adjuntar el evento de doble clic DESPUÉS de renderizar las filas
            attachRowDblClickListeners();
        }
        
        /**
         * Adjunta el event listener de doble clic a todas las filas de la tabla.
         */
        function attachRowDblClickListeners() {
            document.querySelectorAll('#vacation-table-body .worker-row').forEach(row => {
                row.addEventListener('dblclick', (e) => {
                    const targetRow = e.currentTarget; 
                    const index = parseInt(targetRow.dataset.index, 10);
                    
                    // Almacenar el índice actual y mostrar el modal
                    currentRecordIndex = index;
                    showVacationDetailModal();
                });
            });
        }
        
        // --- LÓGICA DEL MODAL DE DETALLE DE VACACIONES ---
        
        /** Cierra el modal de detalle de vacaciones. */
        function closeVacationModal(event) {
            // Cierra al hacer clic en el botón 'x', el fondo (overlay), o con la tecla ESC
            if (!event || event.target.id === 'VacationDetailModal' || event.target.closest('button[data-lucide="x"]')) {
                document.getElementById('VacationDetailModal').style.display = 'none';
            }
        }
        
        /**
         * Muestra el modal de detalle, carga el registro actual y lo posiciona.
         */
        function showVacationDetailModal() {
            const modal = document.getElementById('VacationDetailModal');
            const modalContentWrapper = document.getElementById('vacation-modal-content-wrapper');
            const workerCard = document.getElementById('worker-card');

            if (currentRecordIndex < 0 || currentRecordIndex >= filteredEmployeeData.length) {
                console.error("Índice de registro fuera de rango.");
                return;
            }
            
            const record = filteredEmployeeData[currentRecordIndex];
            const totalRecords = filteredEmployeeData.length;
            
            // 1. Cargar Datos en el Modal
            document.getElementById('registro-count').textContent = `Registro ${currentRecordIndex + 1} de ${totalRecords}`;
            document.getElementById('detail-periodo').textContent = record.PERIODO || 'N/A';
            document.getElementById('detail-concepto').textContent = record.DESCRIPCION_CONCEPTO || 'N/A';
            document.getElementById('detail-dias').textContent = `${record.DIAS_VACACIONES || 0}`;
            document.getElementById('detail-bono').textContent = record.BONO_VACACIONAL;

            // 2. Posicionar el Modal (Clave: Debajo de la tarjeta del trabajador)
            if (workerCard) {
                const cardRect = workerCard.getBoundingClientRect();
                const cardBottomPosition = cardRect.bottom + window.scrollY; 
                
                modalContentWrapper.style.top = `${cardBottomPosition + 20}px`; 
                modalContentWrapper.style.position = 'absolute';
            } else {
                modalContentWrapper.style.top = '100px'; 
            }
            
            // 3. Actualizar estado de navegación
            updateNavigationButtons();

            // 4. Mostrar el Modal
            modal.style.display = 'flex';
            
            if (typeof lucide !== 'undefined' && lucide.createIcons) {
                lucide.createIcons();
            }
        }
        
        /**
         * Navega al registro anterior o siguiente y actualiza el modal.
         * @param {number} direction - -1 para Anterior, 1 para Siguiente.
         */
        function navigateRecord(direction) {
            let newIndex = currentRecordIndex + direction;

            if (newIndex >= 0 && newIndex < filteredEmployeeData.length) {
                currentRecordIndex = newIndex;
                showVacationDetailModal(); 
            }
        }

        /**
         * Habilita o deshabilita los botones de navegación.
         */
        function updateNavigationButtons() {
            const total = filteredEmployeeData.length;
            const prevBtn = document.getElementById('prev-record-btn');
            const nextBtn = document.getElementById('next-record-btn');

            if (prevBtn) prevBtn.classList.toggle('disabled-nav', currentRecordIndex <= 0);
            if (nextBtn) nextBtn.classList.toggle('disabled-nav', currentRecordIndex >= total - 1);
        }

        // --- FUNCIÓN PRINCIPAL DE NAVEGACIÓN ---

        function loadContent(section) {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = ''; 
            
            if (section === 'Inicio') {
                window.location.href = 'Inicio.html';
                return; 
            }
    
            if (section === 'Editar') {
                window.location.href = 'EditarDat.html';
                return;
            }

            if (section === 'Agregar') {
                window.location.href = 'AgregarDat.html';
                return;
            }
    
            if (section === 'Perfil') {
                window.location.href = 'PerfilUser.html';
                return;
            }
    
            if (section === 'Configuración') {
                window.location.href = 'ConfigApp.html';
                return;
            }
            else if (section === 'Vacaciones') {
                
                mainContent.innerHTML = `
                    <div id="data-view-container" class="w-full pb-2">
                        <div id="employee-info-card" class="mb-4"></div>
                        
                        <!-- FILA 1: Checkbox de Filtrado por Periodo (Mantenido separado) -->
                        <div class="flex items-center space-x-2 mb-1"> 
                            
                            <!-- Contenedor del Checkbox -->
                            <div class="flex items-center space-x-2 p-0">
                                <!-- APLICACIÓN DEL CAMBIO 1: Tamaño del checkbox a w-3 h-3 -->
                                <input type="checkbox" id="filterByPeriodCheckbox" onchange="updateFilterPlaceholder()" class="w-4 h-4 rounded text-blue-500 light:bg-gray-200 dark:bg-gray-600 border-gray-400 focus:ring-blue-500">
                                <label for="filterByPeriodCheckbox" class="text-2x1 text-white select-none">Filtrar por Periodo</label>
                            </div>
                        </div>      

                        <!-- FILA 2: Input de Búsqueda y Botones -->
                        <div class="flex items-center space-x-2 mb-2"> 
                            
                            <!-- Input de Búsqueda -->
                            <div class="relative flex-grow rounded-xl"> 
                                <input type="text" id="search-input" 
                                    placeholder="Periodo o Concepto" 
                                    class="w-full pl-10 pr-4 py-2 rounded-xl shadow-inner 
                                           light:bg-white dark:bg-gray-700 
                                           text-gray-900 dark:text-gray-100 
                                           placeholder-gray-400 border light:border-gray-300 dark:border-gray-600 
                                           focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    onkeyup="applyAllFilters()"> 
                                <!-- Icono de búsqueda con buen contraste -->
                                <i data-lucide="search" class="w-5 h-5 absolute left-3 top-1/2 transform -translate-y-1/2 light:text-gray-500 text-red-500"></i> 
                            </div> 
                            
                            <!-- Botones de Limpiar y Recargar -->
                            <button id="clear-search-btn" 
                                    class="p-2.5 rounded-full light:bg-white hover:bg-gray-700 shadow-md transition-colors duration-150 text-red-500 dark:text-red-400 font-bold" 
                                    title="Reiniciar Filtros"
                                    onclick="clearSearchFilter()"> 
                                <i data-lucide="x-circle" class="w-7 h-7"></i> 
                            </button>
                            <button id="reload-icon" class="p-2 rounded-full text-blue-400 hover:bg-gray-700 transition duration-150" title="Recargar Datos (Omitir Caché)">
                                    <i data-lucide="refresh-cw" class="w-6 h-6"></i>
                            </button> 
                        </div>      
                        
                        <div class="flex justify-between items-start mt-1 mb-1"> 
                            <div><h2 class="text-2xl font-bold text-blue-400">Registros de Absentismos</h2></div>                        
                        </div>
                        <div id="table-loading-status" class="text-center py-10" style="display: none;"></div>
                        <div id="table-scroll-wrapper" class="table-scroll-container">
                            <div id="employee-table-container"></div>
                        </div>
                    </div>
                `;
                
                currentSheet = 'Vacaciones';
                loadData();

                document.getElementById('reload-icon').addEventListener('click', () => {
                    currentSortColumn = 'CEDULA';
                    sortOrder = 'asc';
                    loadData(true); 
                });
                
            } 
            else {
                mainContent.innerHTML = `<div class="flex-grow flex items-center justify-center p-8 text-center w-full min-h-[300px]"><div class="bg-gray-700 p-6 rounded-xl shadow-lg w-full max-w-sm text-gray-200"><i data-lucide="alert-triangle" class="w-10 h-10 mx-auto text-yellow-400 mb-3"></i><h3 class="text-xl font-bold mb-2">Sección "${section}"</h3><p class="text-sm">Esta funcionalidad aún está en desarrollo.</p></div></div>`;
                currentSheet = section;
            }
            
            if (typeof lucide !== 'undefined' && lucide.createIcons) {
                lucide.createIcons();
            }
        }
        
        // --- INICIALIZACIÓN ---

        function setActiveFooterButton(section) {
            const footerButtons = document.querySelectorAll('.footer-btn');
            footerButtons.forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-section') === section) {
                    btn.classList.add('active');
                }
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            
            const initialSection = 'Vacaciones';
            loadContent(initialSection); 
            setActiveFooterButton(initialSection); 

            const footerButtons = document.querySelectorAll('.footer-btn');
            // CORRECCIÓN DEL ERROR DE REFERENCIA: Uso correcto de forEach
            footerButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const section = button.getAttribute('data-section');
                    setActiveFooterButton(section);
                    loadContent(section); 
                });
            });
            
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && document.getElementById('VacationDetailModal').style.display === 'flex') {
                    closeVacationModal();
                }
            });
        });

    </script>
</body>
</html>
